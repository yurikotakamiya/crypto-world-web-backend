exports.up = function(knex) {
  return knex.schema.createTable('users', tbl => {
    tbl.increments('user_id').unsigned().primary()
    tbl.string('username', 64).unique().notNullable()
    tbl.string('password', 64).notNullable()
    tbl.string('email', 64).unique().notNullable()
  })
  .createTable('secret_keys', tbl => {
    tbl.integer('user_id')
      .unsigned()    
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.string('secret_key').notNullable()
    tbl.dateTime('expiration').notNullable()
  })
  .createTable('strategies', tbl => {
    tbl.tinyint('strategy_id').unsigned().primary()
    tbl.string('strategy_name', 64).notNullable()
    tbl.text('description').notNullable()
  })
  .createTable('order_sides', tbl => {
    tbl.tinyint('order_side_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('order_actions', tbl => {
    tbl.tinyint('order_action_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('order_states', tbl => {
    tbl.tinyint('order_state_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('order_types', tbl => {
    tbl.tinyint('order_type_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('exchanges', tbl => {
    tbl.tinyint('exchange_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('trading_pairs', tbl => {
    tbl.tinyint('trading_pair_id').unsigned().primary()
    tbl.string('description', 16)
  })
  .createTable('orders', tbl => {
    tbl.bigint('order_id').unsigned().notNullable()
    tbl.integer('user_id')
      .unsigned()
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('strategy_id')
      .unsigned()
      .notNullable()
      .references('strategy_id')
      .inTable('strategies')
    tbl.tinyint('trading_pair_id')
      .unsigned()
      .notNullable()
      .references('trading_pair_id')
      .inTable('trading_pairs')
    tbl.tinyint('order_size').notNullable()
    tbl.double('order_price').notNullable()
    tbl.tinyint('order_side_id')
      .unsigned()
      .notNullable()
      .references('order_side_id')
      .inTable('order_sides')
    tbl.timestamp('create_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.timestamp('update_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.tinyint('order_action_id')
      .unsigned()
      .notNullable()
      .references('order_action_id')
      .inTable('order_actions')
    tbl.tinyint('order_state_id')
      .unsigned()
      .notNullable()
      .references('order_state_id')
      .inTable('order_states')
    tbl.integer('order_leaves_quantity')
    tbl.tinyint('order_type_id')
      .unsigned()
      .notNullable()
      .references('order_type_id')
      .inTable('order_types')
    tbl.bigint('version')
  })
  .createTable('order_history', tbl => {
    tbl.bigint('order_id').unsigned().notNullable()
    tbl.integer('user_id')
      .unsigned()
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('strategy_id')
      .unsigned()
      .notNullable()
      .references('strategy_id')
      .inTable('strategies')
    tbl.tinyint('trading_pair_id')
      .unsigned()
      .notNullable()
      .references('trading_pair_id')
      .inTable('trading_pairs')
    tbl.tinyint('order_size').notNullable()
    tbl.double('order_price').notNullable()
    tbl.tinyint('order_side_id')
      .unsigned()
      .notNullable()
      .references('order_side_id')
      .inTable('order_sides')
    tbl.timestamp('create_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.timestamp('update_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.tinyint('order_action_id')
      .unsigned()
      .notNullable()
      .references('order_action_id')
      .inTable('order_actions')
    tbl.tinyint('order_state_id')
      .unsigned()
      .notNullable()
      .references('order_state_id')
      .inTable('order_states')
    tbl.integer('order_leaves_quantity')
    tbl.tinyint('order_type_id')
      .unsigned()
      .notNullable()
      .references('order_type_id')
      .inTable('order_types')
    tbl.bigint('version')
    tbl.primary(['order_id', 'version'])
  })
  .createTable('api_keys', tbl => {
    tbl.integer('user_id')
      .unsigned()    
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('exchange_id')
      .unsigned()
      .notNullable()
      .references('exchange_id')
      .inTable('exchanges')
    tbl.string('api_key').notNullable()
    tbl.string('api_secret_key').notNullable()
  })
  .createTable('strategy_configs', tbl => {
    tbl.integer('user_id')
      .unsigned()    
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('exchange_id')
      .unsigned()
      .notNullable()
      .references('exchange_id')
      .inTable('exchanges')
    tbl.tinyint('trading_pair_id')
      .unsigned()
      .notNullable()
      .references('trading_pair_id')
      .inTable('trading_pairs')
    tbl.tinyint('strategy_id')
      .unsigned()
      .notNullable()
      .references('strategy_id')
      .inTable('strategies')
  })
};

exports.down = function(knex) {
    return knex.schema
    .dropTableIfExists('secret_keys')
    .dropTableIfExists('users')
    .dropTableIfExists('strategies')
    .dropTableIfExists('orders')
    .dropTableIfExists('order_history')
    .dropTableIfExists('order_sides')
    .dropTableIfExists('order_actions')
    .dropTableIfExists('order_states')
    .dropTableIfExists('order_types')
    .dropTableIfExists('exchanges')
    .dropTableIfExists('trading_pairs')
    .dropTableIfExists('api_keys')
    .dropTableIfExists('strategy_configs')
};
