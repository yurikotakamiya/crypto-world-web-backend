exports.up = function(knex) {
  return knex.schema.createTable('users', tbl => {
    tbl.increments('user_id').unsigned().primary()
    tbl.string('username', 64).unique().notNullable()
    tbl.string('password', 64).notNullable()
    tbl.string('email', 64).unique().notNullable()
  })
  .createTable('secret_keys', tbl => {
    tbl.integer('user_id')
      .unsigned()    
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.string('secret_key').notNullable()
    tbl.dateTime('expiration').notNullable()
  })
  .createTable('strategies', tbl => {
    tbl.tinyint('strategy_id').unsigned().primary()
    tbl.string('strategy_name', 64).notNullable()
    tbl.text('description').notNullable()
  })
  .createTable('orders', tbl => {
    tbl.bigint('order_id').unsigned().notNullable()
    tbl.integer('user_id')
      .unsigned()
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('strategy_id')
      .unsigned()
      .notNullable()
      .references('strategy_id')
      .inTable('strategies')
    tbl.string('trading_pair', 10).notNullable()
    tbl.tinyint('order_size').notNullable()
    tbl.double('order_price').notNullable()
    tbl.tinyint('order_side').notNullable()
    tbl.timestamp('create_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.timestamp('update_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.tinyint('order_action')
    tbl.tinyint('order_state')
    tbl.integer('order_leaves_quantity')
    tbl.tinyint('order_type')
    tbl.bigint('version')
  })
  .createTable('order_history', tbl => {
    tbl.bigint('order_id').unsigned().notNullable()
    tbl.integer('user_id')
      .unsigned()
      .notNullable()
      .references('user_id')
      .inTable('users')
    tbl.tinyint('strategy_id')
      .unsigned()
      .notNullable()
      .references('strategy_id')
      .inTable('strategies')
    tbl.string('trading_pair', 10).notNullable()
    tbl.tinyint('order_size').notNullable()
    tbl.double('order_price').notNullable()
    tbl.tinyint('order_side').notNullable()
    tbl.timestamp('create_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.timestamp('update_time', { precision: 3 }).defaultTo(knex.fn.now(3))
    tbl.tinyint('order_action')
    tbl.tinyint('order_state')
    tbl.integer('order_leaves_quantity')
    tbl.tinyint('order_type')
    tbl.bigint('version')
    tbl.primary(['order_id', 'version'])
  })
  .createTable('order_sides', tbl => {
    tbl.tinyint('order_side_id')
    tbl.string('description', 16)
  })
  .createTable('order_actions', tbl => {
    tbl.tinyint('order_action_id')
    tbl.string('description', 16)
  })
  .createTable('order_states', tbl => {
    tbl.tinyint('order_state_id')
    tbl.string('description', 16)
  })
  .createTable('order_types', tbl => {
    tbl.tinyint('order_type_id')
    tbl.string('description', 16)
  })
};

exports.down = function(knex) {
    return knex.schema
    .dropTableIfExists('secret_keys')
    .dropTableIfExists('users')
    .dropTableIfExists('strategies')
    .dropTableIfExists('orders')
};
